# Imagen base: Debian 12 (bookworm) para compatibilidad con repos de Microsoft
FROM python:3.10-slim-bookworm

ENV ACCEPT_EULA=Y \
    DEBIAN_FRONTEND=noninteractive \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

# Dependencias del sistema
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl ca-certificates gnupg apt-transport-https \
    unixodbc unixodbc-dev gcc g++ \
 && rm -rf /var/lib/apt/lists/*

# Clave y repo de Microsoft para Debian 12 (bookworm) + ODBC 18 y herramientas
RUN curl -fsSL https://packages.microsoft.com/keys/microsoft.asc \
      | gpg --dearmor > /usr/share/keyrings/microsoft-prod.gpg \
 && echo "deb [arch=amd64,arm64 signed-by=/usr/share/keyrings/microsoft-prod.gpg] https://packages.microsoft.com/debian/12/prod bookworm main" \
      > /etc/apt/sources.list.d/microsoft-prod.list \
 && apt-get update \
 && apt-get install -y --no-install-recommends msodbcsql18 mssql-tools18 \
 && rm -rf /var/lib/apt/lists/*

# Añadir mssql-tools18 al PATH para todos los procesos
ENV PATH="/opt/mssql-tools18/bin:${PATH}"

# Código de la app
WORKDIR /opt/dagster/app

# Paquetes Python
RUN pip install --no-cache-dir \
  adlfs \
  dagster==1.10.* \
  dagster-webserver \
  dagster-cloud \
  dagster-duckdb \
  dagster-postgres \
  pandas \
  pyarrow \
  pyodbc \
  python-dotenv \
  SQLAlchemy \
  grpcio==1.60.0 \
  grpcio-health-checking==1.60.0 \
  grpclib==0.4.6 \
# Limpieza por si el resolver metió 'polars'
 && pip uninstall -y polars || true \
# Paquetes Python (2) — forzar LTS al final
 && pip install --no-cache-dir --upgrade --force-reinstall polars-lts-cpu

# Copiar el repositorio al contenedor
COPY . /opt/dagster/app/

# El servidor escuchará en 4000 (coherente con el CMD)
EXPOSE 4000

# CMD allows this to be overridden from run launchers or executors that want
# to run other commands against your repository
#CMD ["dagster", "api", "grpc", "-h", "0.0.0.0", "-p", "4000", "-f", "mcdonalds_etl/definitions.py"]
CMD ["dagster", "code-server", "start", "-h", "0.0.0.0", "-p", "4000", "-f", "./mcdonalds_etl/definitions.py"]